<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WNCT - Structured PSV Inspection</title>
    <style>
        :root { --primary: #000; --defect: #dc3545; --monitor: #fd7e14; --clear: #198754; --vor: #b02a37; }
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; padding: 10px; color: #000; font-size: 11px; margin: 0; }
        
        /* THE WATERMARK SYSTEM */
        #vor-watermark {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            pointer-events: none;
            z-index: 9999; /* Put it on top */
            opacity: 0.15; /* Transparent so text is readable */
            justify-content: center;
            align-items: center;
        }

        .vor-active #vor-watermark {
            display: flex !important;
        }

        .container { 
            max-width: 900px; 
            width: 95%;
            margin: auto; 
            border: 1px solid #000; 
            padding: 15px; 
            background: white; 
            position: relative; 
            box-sizing: border-box;
        }

        .company-header { text-align: center; border-bottom: 2px solid #000; margin-bottom: 10px; padding-bottom: 5px; }
        .header-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; table-layout: fixed; }
        .header-table td { border: 1px solid #000; padding: 3px; vertical-align: top; }
        .label { font-size: 8px; font-weight: bold; display: block; text-transform: uppercase; }
        input, select { border: none; width: 100%; outline: none; font-size: 10px; background: transparent; }

        .block-title { background: #333; color: #fff; font-weight: bold; padding: 5px; border: 1px solid #000; text-transform: uppercase; margin-top: 10px; }
        .checklist-table { width: 100%; border-collapse: collapse; }
        .checklist-table th { border: 1px solid #000; background: #f2f2f2; padding: 4px; }
        .checklist-table td { border: 1px solid #000; padding: 3px; }
        .status-col { width: 35px; text-align: center; }

        .tech-data-grid { display: grid; grid-template-columns: 1.5fr 1fr 1fr; gap: 8px; margin-top: 10px; }
        .data-box { border: 1px solid #000; padding: 5px; }
        .num-select { width: 100%; font-weight: bold; border: 1px solid #eee; }

        .defect-box { border: 2px solid #000; margin-top: 15px; min-height: 40px; }
        .defect-header { background: #000; color: #fff; padding: 4px; font-weight: bold; text-align: center; }
        .defect-row { display: grid; grid-template-columns: 40px 1.5fr 1.5fr 60px; border-bottom: 1px solid #000; align-items: center; padding: 3px; }

        canvas { border: 1px solid #000; background: #fff; cursor: crosshair; }
        .footer-btns { display: flex; justify-content: center; gap: 20px; margin-top: 20px; padding-bottom: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; color: #fff; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn-green { background: var(--clear); }
        .btn-red { background: var(--vor); }

        @media print { 
            @page { margin: 0.8cm; size: portrait; }
            body { background: white !important; }
            .container { width: 100% !important; max-width: 100% !important; border: 1px solid #000; margin: 0; padding: 10px; }
            .footer-btns, .clear-sig { display: none !important; } 
            /* FORCE BACKGROUND COLORS AND IMAGES */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body id="main-body">

<div id="vor-watermark">
    <svg width="600" height="600" viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg">
        <text x="50%" y="50%" fill="red" font-size="120" font-family="Arial Black" font-weight="bold" text-anchor="middle" transform="rotate(-45, 250, 250)">V.O.R</text>
    </svg>
</div>

<div class="container">
    <div class="company-header">
        <h2 style="margin:0;">WEST NORFOLK COMMUNITY TRANSPORT</h2>
        <p style="margin:2px 0;">Unit 7-8 Marchants Close, King's Lynn, Norfolk, PE30 4XJ</p>
    </div>

    <table class="header-table">
        <tr>
            <td><span class="label">Technician</span>
                <select id="techName">
                    <option>Barry Baxter</option><option>Jamie Hurry</option><option>KMS</option>
                </select>
            </td>
            <td><span class="label">Date</span><input type="date" id="currentDate"></td>
            <td><span class="label">Registration</span>
                <select id="regSelector" onchange="autoFillVehicle()">
                    <option value="">-- Select VRM --</option>
                </select>
            </td>
            <td><span class="label">Odometer (Miles)</span><input type="text" placeholder="..."></td>
        </tr>
        <tr>
            <td><span class="label">Vehicle Model</span><input type="text" id="vModel" readonly></td>
            <td><span class="label">Planned Week</span><input type="text" id="plannedWeek" readonly></td>
            <td><span class="label">Actual Week</span><input type="text" id="actualWeek" readonly></td>
            <td><span class="label">Load Condition</span><input type="text" value="Unladen" readonly></td>
        </tr>
        <tr>
            <td colspan="4"><span class="label">Chassis / VIN</span><input type="text" id="vChassis" readonly style="width: 100%;"></td>
        </tr>
    </table>

    <div class="tech-data-grid">
        <div class="data-box">
            <h4>TYRE DEPTHS (mm)</h4>
            <table style="width:100%; text-align:center;">
                <tr><th style="font-size:8px;">Axle</th><th style="font-size:8px;">NS O</th><th style="font-size:8px;">NS I</th><th style="font-size:8px;">OS I</th><th style="font-size:8px;">OS O</th></tr>
                <tr><td>1</td><td><select class="num-select tyre-list"></select></td><td>-</td><td>-</td><td><select class="num-select tyre-list"></select></td></tr>
                <tr><td>2</td><td><select class="num-select tyre-list"></select></td><td><select class="num-select tyre-list"></select></td><td><select class="num-select tyre-list"></select></td><td><select class="num-select tyre-list"></select></td></tr>
            </table>
        </div>
        <div class="data-box">
            <h4>BRAKE PERFORMANCE</h4>
            <table style="width:100%;">
                <tr><td style="font-size:9px;">Service %</td><td><select class="num-select brake-list"></select></td></tr>
                <tr><td style="font-size:9px;">Park %</td><td><select class="num-select brake-list"></select></td></tr>
            </table>
        </div>
        <div class="data-box">
            <h4>TACHOGRAPH</h4>
            <span class="label">2yr Exp</span><input type="date">
            <span class="label">6yr Exp</span><input type="date">
        </div>
    </div>

    <div id="checklist-container"></div>

    <div class="defect-box">
        <div class="defect-header">DEFECT SUMMARY & RECTIFICATION RECORD</div>
        <div id="defect-col-labels" class="defect-row" style="background: #f2f2f2; font-weight: bold; display: none;">
            <div>Ref</div><div>Item Description</div><div>Notes / Rectification</div><div style="text-align: center;">Repaired</div>
        </div>
        <div id="dynamic-defects">
            <p style="text-align:center; padding: 10px; color: #666; margin:0;">No defects identified.</p>
        </div>
    </div>

    <div style="margin-top: 10px; border: 1px solid #000; padding: 10px;">
        <div style="display: flex; justify-content: space-around; align-items: flex-end;">
            <div style="text-align: center;">
                <canvas id="sig-canvas" width="280" height="60"></canvas><br>
                <span style="font-size: 9px; cursor: pointer; color: blue;" class="clear-sig" onclick="clearSignature()">Clear Signature</span>
                <p style="font-weight:bold; margin: 2px 0;">TECHNICIAN SIGNATURE</p>
            </div>
            <div style="text-align:center;">
                <input type="text" id="signedDate" style="border-bottom: 1px solid #000; text-align:center; width: 150px;">
                <p style="font-weight:bold; margin: 2px 0;">DATE SIGNED</p>
            </div>
        </div>
    </div>

    <div class="footer-btns">
        <button type="button" class="btn btn-green" onclick="finalize('Serviceable')">Vehicle Clear</button>
        <button type="button" class="btn btn-red" onclick="finalize('VOR')">Vehicle VOR</button>
    </div>
</div>

<script>
    // Fleet database and initialization scripts remain the same...
    const fleetDatabase = {
        "AU67CVV": { model: "Mercedes Sprinter 513 CDI", vin: "WDB9066552P274254" },
        "AU67CVX": { model: "Mercedes Sprinter 513 CDI", vin: "WDB9066552P245671" },
        "AY66RXH": { model: "Mercedes Sprinter 514 CDI", vin: "WDB9066572P311772" },
        "AY66RXJ": { model: "Mercedes Sprinter 514 CDI", vin: "WDB9066572P311773" },
        "AY66RXK": { model: "Mercedes Sprinter 514 CDI", vin: "WDB9066572P315712" },
        "AY66RXL": { model: "Mercedes Sprinter 514 CDI", vin: "WDB9066572P312303" },
        "BX69CVJ": { model: "Wrightbus Streetlite", vin: "SA9DSRXXX18141696" },
        "CN09GHJ": { model: "Renault Master", vin: "VF1NDD1L639874869" },
        "DV21VFZ": { model: "Vauxhall FLEET SUPPORT", vin: "VXEVBYHRKM7821672" },
        "EA67XGS": { model: "FORD Transit 460 H/R BUS 18 STR", vin: "WF0HXXTTGHHR03237" },
        "EO16MHE": { model: "FORD Transit", vin: "WFWFOHXXTTGHFJ68905" },
        "EU68OKT": { model: "FORD Transit 350", vin: "WF0XXXTTGXJU36733" },
        "EY16ACU": { model: "Mercedes 616", vin: "WDB9066552P228789" },
        "EY16NHE": { model: "Mercedes Sprinter 513 CDI", vin: "WDB9066552P227156" },
        "FN65PYY": { model: "Vauxhall Movano", vin: "WOLMTF8UKFB075084" },
        "FN65ZYT": { model: "FORD Focus", vin: "WF05XXGCC5FS31497" },
        "GX65FDN": { model: "Mercedes Sprinter 516 CDI", vin: "WDB9066572P119209" },
        "KM19EFA": { model: "Mercedes Sprinter 514 CDI", vin: "WDB9066572P641520" },
        "KP21ONF": { model: "Mercedes Sprinter 514 CDI", vin: "W1V9076572P236365" },
        "KV69VYO": { model: "Mercedes Sprinter 514 CDI", vin: "WDB9076572P134360" },
        "KV70RHU": { model: "Mercedes Sprinter 514 CDI", vin: "W1V9076572P206577" },
        "KX21RZH": { model: "Mercedes Sprinter 514 CDI", vin: "W1V9076572P240864" },
        "LK14EAF": { model: "Mercedes Sprinter 513 CDI", vin: "WDB9066552S888558" },
        "LN18EWC": { model: "Mercedes Sprinter 516 CDI", vin: "WDB9061552N736461" },
        "LN18EWD": { model: "Mercedes Sprinter 516 CDI", vin: "WDB9061552N736460" },
        "LN18EWF": { model: "Mercedes Sprinter 516 CDI", vin: "WDB9061552N736462" },
        "LT63VJP": { model: "Mercedes Sprinter 513 CDI", vin: "WDB9066552S831705" },
        "LV16HMZ": { model: "Mercedes Sprinter 513 CDI XLWB", vin: "WDB9066572P312297" },
        "LX66AFJ": { model: "Mercedes Sprinter 514 CDI", vin: "WDB9066572P312301" },
        "LX66AMV": { model: "Mercedes Sprinter 513 CDI XLWB", vin: "WDB9066572P312785" },
        "MX11CZJ": { model: "Wrightbus Streetlite", vin: "SA9DSRXXX10141028" },
        "RV67RCU": { model: "Mercedes Sprinter 516 CDI", vin: "WDB9066572P533630" },
        "RX72TJV": { model: "Mercedes Sprinter", vin: "W1V9076572P435973" },
        "SB66RUH": { model: "VW Caddy", vin: "WV2ZZZ2KZHX054709" },
        "SH16PVW": { model: "VW Caddy", vin: "WV2ZZZ2KZGX110194" },
        "SK18TKN": { model: "Wrightbus Streetlite", vin: "SA9DSRXXX16141325" },
        "SK18TKO": { model: "Wrightbus Streetlite", vin: "SA9DSRXXX16141326" },
        "SK65PWV": { model: "Wrightbus Streetlite", vin: "SA9DSRXXX14141661" },
        "SK68TMZ": { model: "Wrightbus Streetlite", vin: "SA9DSRXXX16141264" },
        "SK68TNE": { model: "Wrightbus Streetlite", vin: "SA9DSRXXX16141266" },
        "SN64FTX": { model: "VW Crafter", vin: "WV1ZZZ2EZD6010779" },
        "SN69ZVS": { model: "Wrightbus Streetlite", vin: "SA9DSRXXX19141792" },
        "SP59TSU": { model: "Mercedes Sprinter 413 CDI", vin: "WDB9066552S434563" },
        "WG71MXN": { model: "Nissan Acenta Electric", vin: "VSKTAAME0U0627344" },
        "WR25OFV": { model: "Mercedes Sprinter 516 CDI BLUEEFFICIENCY LWB", vin: "W1V5H33Z4N334069" },
        "YD66OUE": { model: "VDL Sprinter", vin: "WDB9066572P297425" },
        "YR19GFF": { model: "FORD Transit 460 LEADER ECOBLUE", vin: "WF0MXXTTRMKS00109" }
    };

    function autoFillVehicle() {
        const vrm = document.getElementById('regSelector').value;
        if(fleetDatabase[vrm]) {
            document.getElementById('vModel').value = fleetDatabase[vrm].model;
            document.getElementById('vChassis').value = fleetDatabase[vrm].vin;
        }
    }

    const blocks = [
        { title: "Driverâ€™s Cab & Controls", items: [{r:"3", d:"Seat belts/SRS"}, {r:"17", d:"Demist/defrosting"}, {r:"17", d:"Escape window"}, {r:"18", d:"Driving seat"}, {r:"22", d:"Mirrors"}, {r:"23", d:"Glass/View"}, {r:"25", d:"Wipers/Washers"}, {r:"26", d:"Speedo/Tacho"}, {r:"27", d:"Horn"}, {r:"28", d:"Driving controls"}, {r:"30", d:"Steering column"}, {r:"33", d:"Speed limiter"}, {r:"34", d:"Pressure warning"}]},
        { title: "Interior & Passenger Area", items: [{r:"11", d:"Legal Lettering"}, {r:"16", d:"Passenger doors"}, {r:"16", d:"Emergency exits"}, {r:"21", d:"Interior body/Steps"}, {r:"21", d:"Floor traps/mats"}, {r:"24", d:"Kneeling system"}, {r:"21", d:"Seating"}, {r:"21", d:"Ventilation"}, {r:"21", d:"Grab rails"}, {r:"21", d:"Fire/First Aid"}, {r:"24", d:"Wheelchair lifts/ramps"}]},
        { title: "Exterior & Bodywork", items: [{r:"1", d:"Reg plates"}, {r:"9", d:"Bumper bars"}, {r:"10", d:"Spare wheel"}, {r:"11", d:"Legal Lettering"}, {r:"19", d:"Security of body"}, {r:"14", d:"Wings/Arches"}, {r:"20", d:"Exterior condition"}, {r:"20", d:"Access doors"}, {r:"6", d:"Wheels/Hubs"}, {r:"7", d:"Tyre size/type"}, {r:"8", d:"Tyre condition"}]},
        { title: "Mechanical, Chassis & Braking", items: [{r:"5", d:"Exhaust emission"}, {r:"36", d:"Hand brake lever"}, {r:"37", d:"Service brake pedal"}, {r:"38", d:"ABS/EBS"}, {r:"41", d:"Chassis condition"}, {r:"43", d:"Engine mountings"}, {r:"44", d:"Oil leaks"}, {r:"45", d:"Fuel systems"}, {r:"48", d:"Suspension"}, {r:"53", d:"Axles"}, {r:"54", d:"Steering gear"}, {r:"59", d:"Brake actuators"}]},
        { title: "Lighting & Electrical", items: [{r:"42", d:"Electrical wiring"}, {r:"62", d:"Reflectors"}, {r:"63", d:"Marker lamps"}, {r:"63", d:"Head/Stop lamps"}, {r:"66", d:"Indicators/Hazard"}, {r:"67", d:"Headlamp aim"}]}
    ];

    function init() {
        const selector = document.getElementById('regSelector');
        Object.keys(fleetDatabase).sort().forEach(vrm => {
            const opt = document.createElement('option');
            opt.value = vrm; opt.textContent = vrm;
            selector.appendChild(opt);
        });

        document.querySelectorAll('.tyre-list').forEach(s => { s.innerHTML = '<option value="">-</option>'; for(let i=15; i>=1.0; i-=0.5) s.innerHTML += `<option>${i.toFixed(1)}</option>`; });
        document.querySelectorAll('.brake-list').forEach(s => { s.innerHTML = '<option value="">-</option>'; for(let i=100; i>=0; i--) s.innerHTML += `<option>${i}%</option>`; });

        const container = document.getElementById('checklist-container');
        blocks.forEach((block, bIdx) => {
            let html = `<div class="block-title">${block.title}</div><table class="checklist-table"><thead><tr><th>Ref</th><th>Question</th><th>P</th><th>M</th><th>D</th><th>NA</th></tr></thead><tbody>`;
            block.items.forEach((item, iIdx) => {
                const id = `item-${bIdx}-${iIdx}`;
                html += `<tr><td>[${item.r}]</td><td>${item.d}</td>
                    <td class="status-col"><input type="radio" name="${id}" value="Pass" checked onclick="sync()"></td>
                    <td class="status-col"><input type="radio" name="${id}" value="Monitor" onclick="sync()"></td>
                    <td class="status-col"><input type="radio" name="${id}" value="Defect" onclick="sync()"></td>
                    <td class="status-col"><input type="radio" name="${id}" value="NA" onclick="sync()"></td></tr>`;
            });
            container.innerHTML += html + '</tbody></table>';
        });
        const now = new Date();
        document.getElementById('currentDate').valueAsDate = now;
        document.getElementById('signedDate').value = now.toLocaleDateString();
        document.getElementById('plannedWeek').value = getISOWeek(now);
        document.getElementById('actualWeek').value = getISOWeek(now);
        initSignature();
    }

    function sync() {
        const container = document.getElementById('dynamic-defects');
        const labels = document.getElementById('defect-col-labels');
        let html = ''; let found = false;
        blocks.forEach((block, bIdx) => {
            block.items.forEach((item, iIdx) => {
                const checked = document.querySelector(`input[name="item-${bIdx}-${iIdx}"]:checked`);
                if (checked && (checked.value === 'Monitor' || checked.value === 'Defect')) {
                    found = true;
                    html += `<div class="defect-row"><div>[${item.r}]</div><div>${item.d}</div><div><input type="text" style="border-bottom:1px solid #000;width:95%"></div><div style="text-align:center"><input type="checkbox"></div></div>`;
                }
            });
        });
        labels.style.display = found ? 'grid' : 'none';
        container.innerHTML = found ? html : '<p style="text-align:center; padding: 10px; color: #666; margin:0;">No defects identified.</p>';
    }

    let canvas, ctx, drawing = false;
    function initSignature() {
        canvas = document.getElementById('sig-canvas'); ctx = canvas.getContext('2d');
        canvas.onmousedown = (e) => { drawing = true; ctx.moveTo(e.offsetX, e.offsetY); ctx.beginPath(); };
        canvas.onmousemove = (e) => { if(drawing) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); } };
        window.onmouseup = () => { drawing = false; };
    }
    function clearSignature() { ctx.clearRect(0,0,canvas.width,canvas.height); }

    function finalize(status) {
        if (status === 'VOR') {
            document.body.classList.add('vor-active');
        } else {
            document.body.classList.remove('vor-active');
        }
        
        // Wait for class to be applied then print
        setTimeout(() => {
            window.print();
        }, 300);
    }

    function getISOWeek(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7)); return Math.ceil((((d - new Date(Date.UTC(d.getUTCFullYear(), 0, 1))) / 86400000) + 1) / 7); }
    window.onload = init;
</script>
</body>
</html>
